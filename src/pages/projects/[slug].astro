---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { minima } from "../../lib/minima";
import type { GraphEntity } from "../../sdk/types.gen";
import { buildTitle } from "../../config/site";
import HeroImage from "../../components/HeroImage.astro";
import ProjectRelationships from "../../components/ProjectRelationships.astro";
import { getProjectUrl } from "../../lib/url";

const { slug } = Astro.params;

const response = await minima.getPublicEntityBySlug(slug!, {
  include: "graph",
  depth: 1,
});
const project = response.data as GraphEntity | undefined;

if (!project) {
  return Astro.redirect("/404");
}

// Fetch all articles without limit since:
// 1. The API doesn't support filtering by entity/project
// 2. Total article count is small (< 10)
const articleResponse = await minima.getPublicArticles();
const allArticles = articleResponse.data?.data || [];

const title = await buildTitle(project.name);
const description = (project as any).attributes?.description || "";
---

<BaseLayout title={title} description={description}>
  <article>
    <main
      class="bg-white max-w-4xl mx-auto p-6 rounded shadow border border-sky-600"
    >
      <div class="mb-6">
        <a
          href="/projects"
          class="inline-flex items-center text-blue-600 hover:underline"
        >
          ‚Üê Back to All Projects
        </a>
      </div>

      {
        project.heroImage && (
          <div class="mb-6">
            <HeroImage image={project.heroImage} alt={project.name} />
          </div>
        )
      }
      <h1 class="text-2xl font-medium m-0 mb-6">
        <a href={getProjectUrl(project.slug)}>{project.name}</a>
      </h1>

      {
        project.attributes?.description && (
          <div>
            <p>{project.attributes.description}</p>
          </div>
        )
      }

      <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-2">
        {
          project.externalUrl && (
            <div>
              <div class="text-base mt-2 mb-2 text-gray-500">Live URL</div>
              <p class="text-gray-600">{project.externalUrl}</p>
            </div>
          )
        }

        {
          project.attributes?.category && (
            <div>
              <div class="text-base mt-2 mb-2 text-gray-500">Category</div>
              <p class="text-gray-600">{project.attributes.category}</p>
            </div>
          )
        }

        {
          project.attributes?.techStack && (
            <div>
              <div class="text-base mt-2 mb-2 text-gray-500">Tech Stack</div>
              <p class="text-gray-600">{project.attributes.techStack}</p>
            </div>
          )
        }

        {
          project.attributes?.launchDate && (
            <div>
              <div class="text-base mt-2 mb-2 text-gray-500">Launch Date</div>
              <p class="text-gray-600">{project.attributes.launchDate}</p>
            </div>
          )
        }

        {
          project.attributes?.projectDuration && (
            <div>
              <div class="text-base mt-2 mb-2 text-gray-500">
                Project Duration
              </div>
              <p class="text-gray-600">{project.attributes.projectDuration}</p>
            </div>
          )
        }

        {
          project.attributes?.client && (
            <div>
              <div class="text-base mt-2 mb-2 text-gray-500">Client</div>
              <p class="text-gray-600">{project.attributes.client}</p>
            </div>
          )
        }

        {
          project.attributes?.platform && (
            <div>
              <div class="text-base mt-2 mb-2 text-gray-500">Platform</div>
              <p class="text-gray-600">{project.attributes.platform}</p>
            </div>
          )
        }

        {
          project.type && (
            <div>
              <div class="text-base mt-2 mb-2 text-gray-500">Type</div>
              <p class="text-gray-600">{project.type}</p>
            </div>
          )
        }
      </div>

      <ProjectRelationships projectId={project.id} articles={allArticles} />
    </main>
  </article>
</BaseLayout>
