---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { minima } from "../../lib/minima";
import type {
  PublicArticle,
  PublicEntity,
  PublicImage,
} from "../../sdk/types.gen";
import { buildTitle } from "../../config/site";
import HeroImage from "../../components/HeroImage.astro";

type EntityWithAttributes = PublicEntity & {
  attributes?: Record<string, any>;
  heroImage?: PublicImage;
};

const { slug } = Astro.params;

const response = await minima.getPublicEntityBySlug(slug!);
const project = response.data as EntityWithAttributes | undefined;

if (!project) {
  return Astro.redirect("/404");
}

const articleResponse = await minima.getPublicArticles({ limit: 100 });
const allArticles = articleResponse.data?.data || [];

const relatedArticles: Array<{
  article: PublicArticle;
  relationshipType: string;
}> = [];

for (const article of allArticles) {
  const rels = article.relationships;

  if (rels.itemReviewed && Array.isArray(rels.itemReviewed)) {
    for (const rel of rels.itemReviewed) {
      const entities = Array.isArray(rel.entity) ? rel.entity : [rel.entity];
      if (entities.some((e) => e.id === project.id)) {
        relatedArticles.push({ article, relationshipType: "Review" });
        break;
      }
    }
  }

  if (rels.about && Array.isArray(rels.about)) {
    for (const rel of rels.about) {
      const entities = Array.isArray(rel.entity) ? rel.entity : [rel.entity];
      if (entities.some((e) => e.id === project.id)) {
        relatedArticles.push({ article, relationshipType: "About" });
        break;
      }
    }
  }

  if (rels.mentions && Array.isArray(rels.mentions)) {
    for (const rel of rels.mentions) {
      const entities = Array.isArray(rel.entity) ? rel.entity : [rel.entity];
      if (entities.some((e) => e.id === project.id)) {
        relatedArticles.push({ article, relationshipType: "Mentions" });
        break;
      }
    }
  }
}

const title = await buildTitle(project.name);
const description = (project as any).attributes?.description || "";
---

<BaseLayout title={title} description={description}>
  <article>
    <main
      class="bg-white max-w-4xl mx-auto p-6 rounded shadow border border-sky-600"
    >
      <div class="mb-6">
        <a
          href="/projects"
          class="inline-flex items-center text-blue-600 hover:underline"
        >
          ‚Üê Back to All Projects
        </a>
      </div>

      {
        project.heroImage && (
          <div class="mb-6">
            <HeroImage image={project.heroImage} alt={project.name} />
          </div>
        )
      }
      <h1 class="text-2xl font-medium m-0 mb-6">
        <a href={`/project/${project.slug}`}>{project.name}</a>
      </h1>

      {
        project.attributes?.description && (
          <div>
            <p>{project.attributes.description}</p>
          </div>
        )
      }

      <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-2">
        {
          project.externalUrl && (
            <div>
              <div class="text-base mt-2 mb-2 text-gray-500">Live URL</div>
              <p class="text-gray-600">{project.externalUrl}</p>
            </div>
          )
        }

        {
          project.attributes?.category && (
            <div>
              <div class="text-base mt-2 mb-2 text-gray-500">Category</div>
              <p class="text-gray-600">{project.attributes.category}</p>
            </div>
          )
        }

        {
          project.attributes?.techStack && (
            <div>
              <div class="text-base mt-2 mb-2 text-gray-500">Tech Stack</div>
              <p class="text-gray-600">{project.attributes.techStack}</p>
            </div>
          )
        }

        {
          project.attributes?.launchDate && (
            <div>
              <div class="text-base mt-2 mb-2 text-gray-500">Launch Date</div>
              <p class="text-gray-600">{project.attributes.launchDate}</p>
            </div>
          )
        }

        {
          project.attributes?.projectDuration && (
            <div>
              <div class="text-base mt-2 mb-2 text-gray-500">
                Project Duration
              </div>
              <p class="text-gray-600">{project.attributes.projectDuration}</p>
            </div>
          )
        }

        {
          project.attributes?.client && (
            <div>
              <div class="text-base mt-2 mb-2 text-gray-500">Client</div>
              <p class="text-gray-600">{project.attributes.client}</p>
            </div>
          )
        }
      </div>

      {
        relatedArticles.length > 0 && (
          <div class="mb-6">
            <h2 class="text-2xl font-bold mb-4">
              Related Articles ({relatedArticles.length})
            </h2>
            <ul class="space-y-4">
              {relatedArticles.map(({ article, relationshipType }) => (
                <li class="border-l-4 border-blue-600 pl-4">
                  <h3 class="text-xl font-medium">
                    <a
                      href={`/article/${article.slug}`}
                      class="text-blue-600 hover:underline"
                    >
                      {article.headline}
                    </a>
                  </h3>
                  <p class="text-sm text-gray-500">
                    <strong>Type:</strong> {relationshipType}
                  </p>
                  {article.description && (
                    <p class="text-gray-600">{article.description}</p>
                  )}
                  <p class="text-sm text-gray-500">
                    By {article.author.name} on{" "}
                    {new Date(article.publishedAt * 1000).toLocaleDateString()}
                  </p>
                </li>
              ))}
            </ul>
          </div>
        )
      }
    </main>
  </article>
</BaseLayout>
