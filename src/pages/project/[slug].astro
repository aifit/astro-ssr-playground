---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { minima } from "../../lib/minima";
import type { PublicArticle, PublicEntity } from "../../sdk/types.gen";

type EntityWithAttributes = PublicEntity & {
  attributes?: Record<string, any>;
};

const { slug } = Astro.params;

const response = await minima.getPublicEntityBySlug(slug!);
const project = response.data as EntityWithAttributes | undefined;

if (!project) {
  return Astro.redirect("/404");
}

const articlesResponse = await minima.getPublicArticles({ limit: 100 });
const allArticles = articlesResponse.data?.data || [];

const relatedArticles: Array<{
  article: PublicArticle;
  relationshipType: string;
}> = [];

for (const article of allArticles) {
  const rels = article.relationships;

  if (rels.itemReviewed && Array.isArray(rels.itemReviewed)) {
    for (const rel of rels.itemReviewed) {
      const entities = Array.isArray(rel.entity) ? rel.entity : [rel.entity];
      if (entities.some((e) => e.id === project.id)) {
        relatedArticles.push({ article, relationshipType: "Review" });
        break;
      }
    }
  }

  if (rels.about && Array.isArray(rels.about)) {
    for (const rel of rels.about) {
      const entities = Array.isArray(rel.entity) ? rel.entity : [rel.entity];
      if (entities.some((e) => e.id === project.id)) {
        relatedArticles.push({ article, relationshipType: "About" });
        break;
      }
    }
  }

  if (rels.mentions && Array.isArray(rels.mentions)) {
    for (const rel of rels.mentions) {
      const entities = Array.isArray(rel.entity) ? rel.entity : [rel.entity];
      if (entities.some((e) => e.id === project.id)) {
        relatedArticles.push({ article, relationshipType: "Mentions" });
        break;
      }
    }
  }
}

const title = project.name;
const description = project.attributes?.description || "";
---

<BaseLayout title={title} description={description}>
  <article>
    <main
      class="bg-white max-w-4xl mx-auto p-6 rounded shadow border border-sky-600"
    >
      <h1 class="text-4xl font-bold m-0 mb-6">{project.name}</h1>

      <p class="text-sm text-gray-500 mb-4">
        Published: {new Date(project.publishedAt * 1000).toLocaleDateString()}
      </p>

      {
        project.externalUrl && (
          <div class="mb-6">
            <a
              href={project.externalUrl}
              target="_blank"
              rel="noopener"
              class="inline-block bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700"
            >
              View Live Project â†’
            </a>
          </div>
        )
      }

      {
        project.attributes && Object.keys(project.attributes).length > 0 && (
          <div class="mb-6">
            <h2 class="text-2xl font-bold mb-4">Properties</h2>
            <dl class="space-y-2">
              {Object.entries(project.attributes).map(
                ([key, value]: [string, any]) => (
                  <>
                    <dt class="font-medium text-gray-700">{key}:</dt>
                    <dd class="text-gray-600 ml-4 mb-3">
                      {typeof value === "object"
                        ? JSON.stringify(value, null, 2)
                        : String(value)}
                    </dd>
                  </>
                )
              )}
            </dl>
          </div>
        )
      }

      {
        relatedArticles.length > 0 && (
          <div class="mb-6">
            <h2 class="text-2xl font-bold mb-4">
              Related Articles ({relatedArticles.length})
            </h2>
            <ul class="space-y-4">
              {relatedArticles.map(({ article, relationshipType }) => (
                <li class="border-l-4 border-blue-600 pl-4">
                  <h3 class="text-xl font-medium">
                    <a
                      href={`/article/${article.slug}`}
                      class="text-blue-600 hover:underline"
                    >
                      {article.headline}
                    </a>
                  </h3>
                  <p class="text-sm text-gray-500">
                    <strong>Type:</strong> {relationshipType}
                  </p>
                  {article.description && (
                    <p class="text-gray-600">{article.description}</p>
                  )}
                  <p class="text-sm text-gray-500">
                    By {article.author.name} on{" "}
                    {new Date(article.publishedAt * 1000).toLocaleDateString()}
                  </p>
                </li>
              ))}
            </ul>
          </div>
        )
      }
    </main>
  </article>
</BaseLayout>
