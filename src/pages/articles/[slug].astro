---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { minima } from "../../lib/minima";
import { renderTiptapContent } from "../../lib/editor";

import ArticleHeadline from "../../components/ArticleHeadline.astro";
import ArticleMeta from "../../components/ArticleMeta.astro";
import ArticleRelationships from "../../components/ArticleRelationships.astro";
import { buildTitle } from "../../config/site";

// Get slug from URL params
const slug = Astro.params.slug as string;

// Fetch article by slug
const response = await minima.getPublicArticleBySlug(slug!, {
  include: "graph",
  depth: 1,
});
const article = response.data;

if (!article) {
  return Astro.redirect("/404");
}

const title = await buildTitle(article.headline);
const description = article.description || "";
---

<BaseLayout title={title} description={description}>
  <article>
    <main
      class="bg-white max-w-4xl mx-auto p-6 rounded shadow border border-sky-600"
    >
      <div class="mb-6">
        <a
          href="/articles"
          class="inline-flex items-center text-blue-600 hover:underline"
        >
          ‚Üê Back to All Articles
        </a>
      </div>

      <ArticleHeadline article={article} />

      <div set:html={renderTiptapContent(article.body, article.images || [])} />

      <footer class="max-w-4xl mx-auto">
        <ArticleRelationships relationships={article.relationships} />
        <ArticleMeta article={article} />
      </footer>
    </main>
  </article>
</BaseLayout>
